<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calcora â€” Explainable Math Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css?v=3" />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div>
            <h1><i class="fas fa-calculator"></i> Calcora</h1>
            <p class="tagline">Self-hosted, explainable mathematical computation engine</p>
          </div>
          <div class="header-stats">
            <div class="stat">
              <div class="stat-value">39+</div>
              <div class="stat-label">Differentiation Rules</div>
            </div>
            <div class="stat">
              <div class="stat-value">100%</div>
              <div class="stat-label">Step-by-Step</div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
              <i class="fas fa-moon" id="theme-icon"></i>
            </button>
          </div>
        </div>
      </div>
    </header>
    <style>
      .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
      }
      
      .btn-icon:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      
      .format-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }
      
      .btn-secondary:hover {
        background: var(--border);
      }
      
      .output-value.copyable {
        font-family: 'JetBrains Mono', monospace;
        font-size: 16px;
        text-align: left;
        white-space: pre-wrap;
        word-wrap: break-word;
        user-select: all;
        cursor: text;
      }
      
      .output-value.typeset {
        text-align: center;
      }
    </style>

    <main class="container">
      <section class="panel">
        <div class="row">
          <label>
            Operation
            <select id="operationType">
              <option value="differentiate" selected>Differentiate</option>
              <option value="matrix_multiply">Matrix Multiply</option>
              <option value="matrix_determinant">Matrix Determinant</option>
              <option value="matrix_inverse">Matrix Inverse</option>
              <option value="matrix_rref">Matrix RREF</option>
              <option value="matrix_eigenvalues">Matrix Eigenvalues</option>
              <option value="matrix_lu">Matrix LU Decomposition</option>
            </select>
          </label>

          <label id="variableLabel">
            Variable
            <input id="variable" type="text" value="x" style="width: 60px; text-align: center;" placeholder="x" />
          </label>

          <label id="orderLabel">
            Order
            <select id="order">
              <option value="1" selected>1st (d/dx)</option>
              <option value="2">2nd (dÂ²/dxÂ²)</option>
              <option value="3">3rd (dÂ³/dxÂ³)</option>
              <option value="4">4th</option>
              <option value="5">5th</option>
            </select>
          </label>

          <label>
            Verbosity
            <select id="verbosity">
              <option value="concise">Concise</option>
              <option value="detailed" selected>Detailed</option>
              <option value="teacher">Teacher</option>
            </select>
          </label>

          <button id="run" class="btn-primary"><i class="fas fa-play-circle"></i> Run</button>
        </div>

        <div id="calcInput">
          <label class="block">
            <i class="fas fa-function"></i> Expression
            <input id="expr" type="text" value="sin(x**2)" spellcheck="false" placeholder="Enter expression..." />
          </label>

          <div class="examples">
            <span class="examples-label">Examples:</span>
            <button class="example-btn" data-expr="x**2 * sin(x)">Product Rule</button>
            <button class="example-btn" data-expr="x**x">Logarithmic</button>
            <button class="example-btn" data-expr="sinh(x**2)">Hyperbolic</button>
            <button class="example-btn" data-expr="asin(x**2)">Inverse Trig</button>
            <button class="example-btn" data-expr="erf(x**2)">Error Function</button>
            <button class="example-btn" data-expr="Abs(x**3)">Absolute Value</button>
            <button class="example-btn" data-expr="x*y + y**2" data-var="y">Multi-variable</button>
          </div>
        </div>

        <div id="matrixInput" style="display: none;">
          <label class="block">
            <i class="fas fa-table"></i> Matrix A
            <textarea id="matrixA" rows="3" spellcheck="false" placeholder='[[1,2],[3,4]] or [["a","b"],["c","d"]]' style="font-family: monospace;">[[1,2],[3,4]]</textarea>
            <small style="color: var(--text-tertiary); margin-top: 4px; display: block;">Tip: Use strings for symbols: [["a","b"],["c","d"]]</small>
          </label>

          <label class="block" id="matrixBLabel">
            <i class="fas fa-table"></i> Matrix B
            <textarea id="matrixB" rows="3" spellcheck="false" placeholder='[[5,6],[7,8]] or [["x"],["y"]]' style="font-family: monospace;">[[5,6],[7,8]]</textarea>
          </label>

          <div class="examples">
            <span class="examples-label">Examples:</span>
            <button class="matrix-example-btn" data-op="matrix_multiply" data-a="[[1,2],[3,4]]" data-b="[[5,6],[7,8]]">2Ã—2 Multiply</button>
            <button class="matrix-example-btn" data-op="matrix_determinant" data-a="[[2,1,3],[1,0,1],[1,2,1]]">3Ã—3 Determinant</button>
            <button class="matrix-example-btn" data-op="matrix_inverse" data-a="[[1,2],[3,4]]">2Ã—2 Inverse</button>
            <button class="matrix-example-btn" data-op="matrix_rref" data-a="[[1,2,3],[4,5,6]]">2Ã—3 RREF</button>
            <button class="matrix-example-btn" data-op="matrix_eigenvalues" data-a="[[1,2],[2,1]]">2Ã—2 Eigenvalues</button>
            <button class="matrix-example-btn" data-op="matrix_lu" data-a="[[2,1,1],[4,-6,0],[-2,7,2]]">3Ã—3 LU</button>
            <button class="matrix-example-btn" data-op="matrix_determinant" data-a='[["a","b"],["c","d"]]'>Symbolic Det</button>
            <button class="matrix-example-btn" data-op="matrix_inverse" data-a='[["a","b"],["c","d"]]'>Symbolic Inverse</button>
            <button class="matrix-example-btn" data-op="matrix_multiply" data-a='[["a","b"]]' data-b='[["x"],["y"]]'>Symbolic Multiply</button>
          </div>
        </div>

        <div class="row small">
          <label class="checkbox">
            <input id="showJson" type="checkbox" />
            Show JSON
          </label>

          <span id="status" class="status"></span>
        </div>
      </section>

      <section class="panel result-panel" id="resultPanel" style="display: none;">
        <div class="result-header">
          <h2><i class="fas fa-check-circle" style="color: var(--success);"></i> Result</h2>
          <div class="result-meta">
            <button class="btn-icon" onclick="toggleResultFormat()" title="Toggle format (F)" style="margin-right: 12px;">
              <i class="fas fa-exchange-alt"></i>
            </button>
            <span id="stepCount" class="badge"></span>
            <span id="timing" class="timing"></span>
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span class="format-badge" id="formatBadge">
            <i class="fas fa-font"></i> Typeset Format
          </span>
          <button class="btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="copyResultToClipboard(event)">
            <i class="fas fa-copy"></i> Copy Result
          </button>
        </div>
        
        <div class="result-output">
          <div class="output-label">Output</div>
          <div class="output-value" id="output"></div>
        </div>

        <details open class="steps-section">
          <summary><h3><i class="fas fa-list-ol"></i> Step-by-Step Explanation</h3></summary>
          <ol id="steps" class="steps"></ol>
        </details>

        <details id="jsonWrap" class="json-section hidden">
          <summary><h3><i class="fas fa-code"></i> Raw JSON</h3></summary>
          <pre class="json-pre" id="json"></pre>
        </details>
      </section>

      <section class="panel features-panel">
        <h3><i class="fas fa-book"></i> Supported Rules</h3>
        <div class="rules-grid">
          <div class="rule-category">
            <div class="rule-category-title">ğŸ“ Basic Rules</div>
            <ul class="rule-list">
              <li><code>diff_constant</code> â€” Constant â†’ 0 <span class="syntax">e.g. 5, pi, e</span></li>
              <li><code>diff_identity</code> â€” Identity â†’ 1 <span class="syntax">e.g. x</span></li>
              <li><code>sum_rule</code> â€” Sum: (f+g)' = f' + g' <span class="syntax">e.g. x + sin(x)</span></li>
              <li><code>constant_multiple</code> â€” Constant multiple: (cÂ·f)' = cÂ·f' <span class="syntax">e.g. 3*x**2</span></li>
              <li><code>power_rule</code> â€” Power: (x^n)' = nÂ·x^(n-1) <span class="syntax">e.g. x**5</span></li>
              <li><code>product_rule</code> â€” Product: (fÂ·g)' = f'Â·g + fÂ·g' <span class="syntax">e.g. x*sin(x)</span></li>
              <li><code>quotient_rule</code> â€” Quotient: (f/g)' = (f'Â·g - fÂ·g')/gÂ² <span class="syntax">e.g. sin(x)/x</span></li>
              <li><code>logarithmic_differentiation</code> â€” (u^v)' with both varying <span class="syntax">e.g. x**x</span></li>
            </ul>
          </div>
          
          <div class="rule-category">
            <div class="rule-category-title">ğŸ“ Trigonometric</div>
            <ul class="rule-list">
              <li><code>chain_rule_sin</code> â€” sin(u)' = cos(u)Â·u' <span class="syntax">e.g. sin(x**2)</span></li>
              <li><code>chain_rule_cos</code> â€” cos(u)' = -sin(u)Â·u' <span class="syntax">e.g. cos(3*x)</span></li>
              <li><code>chain_rule_tan</code> â€” tan(u)' = secÂ²(u)Â·u' <span class="syntax">e.g. tan(x**2)</span></li>
              <li><code>chain_rule_sec</code> â€” sec(u)' = sec(u)tan(u)Â·u' <span class="syntax">e.g. sec(x)</span></li>
              <li><code>chain_rule_csc</code> â€” csc(u)' = -csc(u)cot(u)Â·u' <span class="syntax">e.g. csc(x)</span></li>
              <li><code>chain_rule_cot</code> â€” cot(u)' = -cscÂ²(u)Â·u' <span class="syntax">e.g. cot(x)</span></li>
            </ul>
          </div>
          
          <div class="rule-category">
            <div class="rule-category-title">ğŸ”„ Inverse Trig</div>
            <ul class="rule-list">
              <li><code>chain_rule_asin</code> â€” asin(u)' = u'/âˆš(1-uÂ²) <span class="syntax">e.g. asin(x)</span></li>
              <li><code>chain_rule_acos</code> â€” acos(u)' = -u'/âˆš(1-uÂ²) <span class="syntax">e.g. acos(x)</span></li>
              <li><code>chain_rule_atan</code> â€” atan(u)' = u'/(1+uÂ²) <span class="syntax">e.g. atan(x)</span></li>
              <li><code>chain_rule_asec</code> â€” asec(u)' with chain rule <span class="syntax">e.g. asec(x)</span></li>
              <li><code>chain_rule_acsc</code> â€” acsc(u)' with chain rule <span class="syntax">e.g. acsc(x)</span></li>
              <li><code>chain_rule_acot</code> â€” acot(u)' with chain rule <span class="syntax">e.g. acot(x)</span></li>
            </ul>
          </div>
          
          <div class="rule-category">
            <div class="rule-category-title">ğŸŒŠ Hyperbolic</div>
            <ul class="rule-list">
              <li><code>chain_rule_sinh</code> â€” sinh(u)' = cosh(u)Â·u' <span class="syntax">e.g. sinh(x**2)</span></li>
              <li><code>chain_rule_cosh</code> â€” cosh(u)' = sinh(u)Â·u' <span class="syntax">e.g. cosh(x)</span></li>
              <li><code>chain_rule_tanh</code> â€” tanh(u)' = sechÂ²(u)Â·u' <span class="syntax">e.g. tanh(x)</span></li>
              <li><code>chain_rule_asinh</code> â€” asinh(u)' with chain rule <span class="syntax">e.g. asinh(x)</span></li>
              <li><code>chain_rule_acosh</code> â€” acosh(u)' with chain rule <span class="syntax">e.g. acosh(x)</span></li>
              <li><code>chain_rule_atanh</code> â€” atanh(u)' with chain rule <span class="syntax">e.g. atanh(x)</span></li>
            </ul>
          </div>
          
          <div class="rule-category">
            <div class="rule-category-title">ğŸ“ˆ Exponential & Log</div>
            <ul class="rule-list">
              <li><code>chain_rule_exp</code> â€” exp(u)' = exp(u)Â·u' <span class="syntax">e.g. exp(x**2)</span></li>
              <li><code>chain_rule_log</code> â€” log(u)' = u'/u <span class="syntax">e.g. log(x)</span></li>
            </ul>
          </div>
          
          <div class="rule-category">
            <div class="rule-category-title">ğŸ”¬ Special Functions</div>
            <ul class="rule-list">
              <li><code>chain_rule_erf</code> â€” erf(u)' = (2/âˆšÏ€)Â·exp(-uÂ²)Â·u' <span class="syntax">e.g. erf(x**2)</span></li>
              <li><code>chain_rule_gamma</code> â€” gamma(u)' = Î“(u)Â·Ïˆ(u)Â·u' <span class="syntax">e.g. gamma(x)</span></li>
              <li><code>chain_rule_heaviside</code> â€” Heaviside(u)' = Î´(u)Â·u' <span class="syntax">e.g. Heaviside(x)</span></li>
              <li><code>chain_rule_abs</code> â€” |u|' = sign(u)Â·u' <span class="syntax">e.g. Abs(x**3)</span></li>
              <li><code>chain_rule_floor</code> â€” âŒŠuâŒ‹' = 0 (except at integers) <span class="syntax">e.g. floor(x)</span></li>
              <li><code>chain_rule_ceiling</code> â€” âŒˆuâŒ‰' = 0 (except at integers) <span class="syntax">e.g. ceiling(x)</span></li>
            </ul>
          </div>
        </div>

        <h3><i class="fas fa-border-all"></i> Linear Algebra Operations</h3>
        <div class="rules-grid">
          <div class="rule-category">
            <div class="rule-category-title">ğŸ”¢ Matrix Operations</div>
            <ul class="rule-list">
              <li><code>matrix_multiply</code> â€” Multiply two matrices element-by-element <span class="syntax">A Ã— B</span></li>
              <li><code>matrix_determinant</code> â€” Calculate determinant (2Ã—2, 3Ã—3, nÃ—n) <span class="syntax">det(A)</span></li>
              <li><code>matrix_inverse</code> â€” Find inverse matrix Aâ»Â¹ <span class="syntax">Aâ»Â¹ where AAâ»Â¹ = I</span></li>
              <li><code>matrix_rref</code> â€” Row reduce to echelon form <span class="syntax">RREF(A)</span></li>
              <li><code>matrix_eigenvalues</code> â€” Find eigenvalues and eigenvectors <span class="syntax">Av = Î»v</span></li>
              <li><code>matrix_lu</code> â€” LU decomposition with pivoting <span class="syntax">PA = LU</span></li>
            </ul>
            <p style="margin-top: 12px; color: #666; font-size: 14px;">
              ğŸ’¡ <strong>Symbolic Matrices:</strong> Use quoted strings for symbols: <code>[["a","b"],["c","d"]]</code><br>
              Supports numeric, symbolic, and mixed entries!
            </p>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="container">
        <p class="footer-text">Calcora v0.1 â€” Open source, self-hosted, privacy-first mathematical computation</p>
      </div>
    </footer>

    <script>
      // Theme toggle
      function toggleTheme() {
        document.body.classList.toggle('dark-theme');
        const isDark = document.body.classList.contains('dark-theme');
        document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        localStorage.setItem('calcora-engine-theme', isDark ? 'dark' : 'light');
      }

      // Load saved theme
      document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('calcora-engine-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
          document.body.classList.add('dark-theme');
          document.getElementById('theme-icon').className = 'fas fa-sun';
        }
      });
      
      // Format toggle state - use window scope to match app.js
      window.isTypesetFormat = true;
      window.currentResultData = null;
      
      function toggleResultFormat() {
        if (!window.currentResultData) return;
        window.isTypesetFormat = !window.isTypesetFormat;
        displayCurrentResult();
      }
      
      function displayCurrentResult() {
        if (!window.currentResultData) return;
        
        const output = document.getElementById('output');
        const badge = document.getElementById('formatBadge');
        
        if (window.isTypesetFormat) {
          output.className = 'output-value typeset';
          badge.innerHTML = '<i class="fas fa-font"></i> Typeset Format';
          output.innerHTML = window.currentResultData.formatted;
        } else {
          output.className = 'output-value copyable';
          badge.innerHTML = '<i class="fas fa-code"></i> Copyable Format';
          output.textContent = window.currentResultData.raw;
        }
      }
      
      function copyResultToClipboard(event) {
        if (!window.currentResultData || !window.currentResultData.raw) {
          console.error('No result to copy');
          return;
        }
        
        navigator.clipboard.writeText(window.currentResultData.raw).then(() => {
          const btn = event ? event.target.closest('button') : null;
          if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.style.background = 'var(--success)';
            btn.style.color = 'white';
            setTimeout(() => {
              btn.innerHTML = originalHTML;
              btn.style.background = '';
              btn.style.color = '';
            }, 1500);
          }
          console.log('Copied to clipboard');
        }).catch(err => {
          console.error('Failed to copy:', err);
          alert('Failed to copy to clipboard');
        });
      }
      
      // Keyboard shortcut for format toggle
      document.addEventListener('keydown', (e) => {
        if (e.key === 'f' && !e.ctrlKey && !e.altKey && !e.metaKey) {
          if (!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
            e.preventDefault();
            toggleResultFormat();
          }
        }
      });
    </script>
    <script src="/static/app.js?v=4"></script>
  </body>
</html>
