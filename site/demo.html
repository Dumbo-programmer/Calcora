<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcora â€” Interactive Mathematical Computation Platform</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light theme colors */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-mesh: 
                radial-gradient(at 40% 20%, hsla(28,100%,74%,0.15) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,100%,56%,0.15) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355,100%,93%,0.15) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(340,100%,76%,0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22,100%,77%,0.15) 0px, transparent 50%),
                radial-gradient(at 80% 100%, hsla(242,100%,70%,0.15) 0px, transparent 50%);
        }

        body.dark-theme {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --primary-light: #a5b4fc;
            --secondary: #a78bfa;
            --accent: #f472b6;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.5);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5);
            
            --gradient-mesh: 
                radial-gradient(at 40% 20%, hsla(28,100%,74%,0.08) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,100%,56%,0.08) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355,100%,93%,0.08) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(340,100%,76%,0.08) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22,100%,77%,0.08) 0px, transparent 50%),
                radial-gradient(at 80% 100%, hsla(242,100%,70%,0.08) 0px, transparent 50%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: var(--gradient-mesh);
            z-index: -1;
            opacity: 1;
        }

        /* Glassmorphism utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        body.dark-theme .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Header with glass effect */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1.5rem 2rem;
            backdrop-filter: blur(20px) saturate(180%);
            background: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        body.dark-theme .header {
            background: rgba(15, 23, 42, 0.7);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo i {
            font-size: 2rem;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
        }

        /* Main container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Split layout */
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 1200px) {
            .split-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Card with modern design */
        .card {
            background: var(--bg-primary);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-title i {
            color: var(--primary);
        }

        /* Tabs with modern design */
        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 1rem;
            margin-bottom: 2rem;
        }

        .tab {
            flex: 1;
            padding: 0.875rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab:hover {
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .tab.active {
            background: var(--bg-primary);
            color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        /* Form elements with modern style */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9375rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: var(--bg-primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Example chips */
        .examples {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .example-chip {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        .example-chip:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Results area */
        .result-section {
            margin-top: 2rem;
            padding: 2rem;
            background: var(--bg-tertiary);
            border-radius: 1.5rem;
            border: 2px dashed var(--border);
            min-height: 300px;
            display: none;
        }

        .result-section.visible {
            display: block;
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .result-output {
            padding: 1.5rem;
            background: var(--bg-primary);
            border-radius: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--success);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .result-output .katex {
            font-size: 1.5rem;
        }

        /* Steps with timeline design */
        .steps {
            position: relative;
        }

        .step {
            position: relative;
            padding: 1.5rem;
            padding-left: 3rem;
            background: var(--bg-primary);
            border-radius: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary);
            animation: fadeInStep 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }

        .step:nth-child(1) { animation-delay: 0.1s; }
        .step:nth-child(2) { animation-delay: 0.2s; }
        .step:nth-child(3) { animation-delay: 0.3s; }
        .step:nth-child(4) { animation-delay: 0.4s; }
        .step:nth-child(5) { animation-delay: 0.5s; }

        @keyframes fadeInStep {
            to {
                opacity: 1;
                transform: translateX(0);
            }
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
        }

        .step::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 1.5rem;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .step-rule {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .step-explanation {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        /* Graph container */
        .graph-container {
            background: var(--bg-primary);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .graph-container.visible {
            display: block;
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .graph-canvas-wrapper {
            position: relative;
            height: 400px;
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1rem;
        }

        /* Loading state */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.visible {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.125rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Error state */
        .error-banner {
            display: none;
            padding: 1.5rem;
            background: var(--error);
            color: white;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .error-banner.visible {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .error-banner i {
            font-size: 1.5rem;
        }

        /* History panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--bg-primary);
            box-shadow: var(--shadow-xl);
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
        }

        .history-panel.visible {
            right: 0;
        }

        .history-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: var(--bg-secondary);
        }

        /* Keyboard shortcuts tooltip */
        .shortcuts-hint {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-primary);
            border-radius: 1rem;
            box-shadow: var(--shadow-xl);
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: none;
        }

        .shortcuts-hint.visible {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Success pulse animation */
        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .result-section.visible {
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1), successPulse 0.6s ease-in-out 0.5s;
        }
        
        /* Input focus highlight */
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 0 20px rgba(99, 102, 241, 0.2);
            background: var(--bg-primary);
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .history-panel {
                width: 100%;
                right: -100%;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            text-align: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 0.875rem;
            box-shadow: var(--shadow-md);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Action buttons */
        .action-bar {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .action-btn {
            flex: 1;
            padding: 1rem;
            background: var(--gradient-1);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn i {
            font-size: 1.25rem;
        }

        /* Export menu */
        .export-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-primary);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-xl);
            padding: 0.5rem;
            min-width: 200px;
            display: none;
        }

        .export-menu.visible {
            display: block;
            animation: fadeIn 0.2s;
        }

        .export-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .export-item:hover {
            background: var(--bg-secondary);
        }

        /* Format badge */
        .format-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Matrix display improvements */
        .result-output.copyable {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            user-select: all;
            cursor: text;
        }

        .result-output.typeset {
            text-align: center;
        }

        .matrix-display {
            display: inline-block;
            text-align: left;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .matrix-row {
            display: block;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-calculator"></i>
                <span>Calcora</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon tooltip" onclick="toggleHistory()" title="Computation History">
                    <i class="fas fa-history"></i>
                    <span class="tooltiptext">History (Ctrl+H)</span>
                </button>
                <button class="btn-icon tooltip" onclick="toggleTheme()" title="Toggle Theme">
                    <i class="fas fa-moon" id="theme-icon"></i>
                    <span class="tooltiptext">Toggle Theme</span>
                </button>
                <button class="btn-icon tooltip" onclick="showShortcuts()" title="Keyboard Shortcuts">
                    <i class="fas fa-keyboard"></i>
                    <span class="tooltiptext">Shortcuts (Ctrl+/)</span>
                </button>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Home
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Main Layout -->
        <div class="split-layout">
            <!-- Left: Input Panel -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-edit"></i>
                            Input
                        </h3>
                    </div>

                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab active" data-tab="differentiate" onclick="switchTab('differentiate')">
                            <i class="fas fa-function"></i>
                            Differentiation
                        </button>
                        <button class="tab" data-tab="matrix" onclick="switchTab('matrix')">
                            <i class="fas fa-table"></i>
                            Matrices
                        </button>
                    </div>

                    <!-- Differentiation Tab -->
                    <div class="tab-content active" id="differentiate-content">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-lightbulb"></i> Quick Examples
                            </label>
                            <div class="examples">
                                <span class="example-chip" onclick="setExample('sin(x**2)', 'x')">sin(xÂ²)</span>
                                <span class="example-chip" onclick="setExample('x**3 * cos(x)', 'x')">xÂ³Â·cos(x)</span>
                                <span class="example-chip" onclick="setExample('exp(x**2)', 'x')">e^(xÂ²)</span>
                                <span class="example-chip" onclick="setExample('log(x**2 + 1)', 'x')">ln(xÂ² + 1)</span>
                                <span class="example-chip" onclick="setExample('tan(x) + x**2', 'x')">tan(x) + xÂ²</span>
                                <span class="example-chip" onclick="setExample('(x**2 + 1) / (x - 1)', 'x')">Rational</span>
                                <span class="example-chip" onclick="setExample('sqrt(x**2 + 4)', 'x')">âˆš(xÂ² + 4)</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-function"></i> Expression
                                <span style="color: var(--error); margin-left: 4px;" id="expr-required">*</span>
                            </label>
                            <input type="text" id="diff-expr" class="form-input" placeholder="Try: sin(x**2) or x**3*cos(x)" value="sin(x**2)">
                            <small style="color: var(--text-tertiary); font-size: 0.8125rem; margin-top: 0.5rem; display: block;">
                                ðŸ’¡ <strong>Syntax:</strong> Use <code>**</code> for powers (x**2), <code>*</code> for multiply. Available: sin, cos, tan, exp, log, sqrt, sinh, asin, etc.
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-x"></i> Variable to differentiate
                                <span style="color: var(--error); margin-left: 4px;">*</span>
                            </label>
                            <input type="text" id="diff-var" class="form-input" placeholder="Usually 'x' or 'y'" value="x">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-layer-group"></i> Verbosity
                            </label>
                            <select id="diff-verbosity" class="form-select">
                                <option value="concise">Concise</option>
                                <option value="detailed" selected>Detailed</option>
                                <option value="teacher">Teacher Mode</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="show-graph" checked style="margin-right: 0.5rem;">
                                <i class="fas fa-chart-line"></i> Show Interactive Graph
                            </label>
                        </div>

                        <div class="action-bar">
                            <button class="action-btn" onclick="computeDifferentiate()">
                                <i class="fas fa-play-circle"></i>
                                Differentiate
                            </button>
                        </div>
                    </div>

                    <!-- Matrix Tab -->
                    <div class="tab-content" id="matrix-content" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-lightbulb"></i> Quick Examples
                            </label>
                            <div class="examples">
                                <span class="example-chip" onclick="setMatrixExample('determinant', '[[1,2],[3,4]]')">Det 2Ã—2</span>
                                <span class="example-chip" onclick="setMatrixExample('inverse', '[[1,2],[3,4]]')">Inverse</span>
                                <span class="example-chip" onclick="setMatrixExample('determinant', '[[&quot;a&quot;,&quot;b&quot;],[&quot;c&quot;,&quot;d&quot;]]')">Symbolic Det</span>
                                <span class="example-chip" onclick="setMatrixExample('multiply', '[[1,2],[3,4]]', '[[5,6],[7,8]]')">Multiply</span>
                                <span class="example-chip" onclick="setMatrixExample('eigenvalues', '[[3,1],[1,3]]')">Eigenvalues</span>
                                <span class="example-chip" onclick="setMatrixExample('lu', '[[2,1,1],[4,-6,0],[-2,7,2]]')">LU Decomp</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-cogs"></i> Operation
                            </label>
                            <select id="matrix-operation" class="form-select" onchange="toggleMatrixB()">
                                <option value="matrix_determinant">Determinant</option>
                                <option value="matrix_inverse">Inverse</option>
                                <option value="matrix_multiply">Multiply</option>
                                <option value="matrix_rref">RREF</option>
                                <option value="matrix_eigenvalues">Eigenvalues</option>
                                <option value="matrix_lu">LU Decomposition</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-table"></i> Matrix A
                                <span style="color: var(--error); margin-left: 4px;">*</span>
                            </label>
                            <textarea id="matrix-a" class="form-textarea" placeholder='[[1,2],[3,4]] or [["a","b"],["c","d"]] for symbolic'>[[1,2],[3,4]]</textarea>
                            <small style="color: var(--text-tertiary); font-size: 0.8125rem; margin-top: 0.5rem; display: block;">
                                ðŸ’¡ <strong>Format:</strong> [[row1_col1, row1_col2], [row2_col1, row2_col2]]. Use quotes for symbols: [["a","b"],["c","d"]]
                            </small>
                            <div id="matrix-a-preview" style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px; display: none; font-size: 0.875rem;">
                                <strong>Preview:</strong> <span id="matrix-a-dimensions"></span>
                            </div>
                        </div>

                        <div class="form-group" id="matrix-b-group" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-table"></i> Matrix B (for multiplication)
                                <span style="color: var(--error); margin-left: 4px;">*</span>
                            </label>
                            <textarea id="matrix-b" class="form-textarea" placeholder='[[5,6],[7,8]]'>[[5,6],[7,8]]</textarea>
                            <small style="color: var(--text-tertiary); font-size: 0.8125rem; margin-top: 0.5rem; display: block;">
                                ðŸ’¡ Must be compatible dimensions for multiplication
                            </small>
                            <div id="matrix-b-preview" style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px; display: none; font-size: 0.875rem;">
                                <strong>Preview:</strong> <span id="matrix-b-dimensions"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-layer-group"></i> Verbosity
                            </label>
                            <select id="matrix-verbosity" class="form-select">
                                <option value="concise">Concise</option>
                                <option value="detailed" selected>Detailed</option>
                                <option value="teacher">Teacher Mode</option>
                            </select>
                        </div>

                        <div class="action-bar">
                            <button class="action-btn" onclick="computeMatrix()">
                                <i class="fas fa-play-circle"></i>
                                Compute
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Output Panel -->
            <div>
                <!-- Loading State -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Computing...</div>
                </div>

                <!-- Error Banner -->
                <div class="error-banner" id="error-banner">
                    <i class="fas fa-exclamation-circle"></i>
                    <div id="error-message"></div>
                </div>

                <!-- Results -->
                <div class="card result-section" id="result-section">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            Result
                        </h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-icon tooltip" onclick="toggleResultFormat()" title="Toggle Format">
                                <i class="fas fa-exchange-alt" id="format-toggle-icon"></i>
                                <span class="tooltiptext">Toggle Format (F)</span>
                            </button>
                            <div style="position: relative;">
                                <button class="btn-icon" onclick="toggleExportMenu()">
                                    <i class="fas fa-download"></i>
                                </button>
                                <div class="export-menu" id="export-menu">
                                <div class="export-item" onclick="exportAs('json')">
                                    <i class="fas fa-file-code"></i> Export as JSON
                                </div>
                                <div class="export-item" onclick="exportAs('text')">
                                    <i class="fas fa-file-alt"></i> Export as Text
                                </div>
                                <div class="export-item" onclick="exportAs('latex')">
                                    <i class="fas fa-file-medical-alt"></i> Export as LaTeX
                                </div>
                                <div class="export-item" onclick="copyToClipboard()">
                                    <i class="fas fa-copy"></i> Copy to Clipboard
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span class="format-badge" id="format-badge">
                            <i class="fas fa-font"></i> Typeset Format
                        </span>
                        <button class="btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="copyResultToClipboard(event)">
                            <i class="fas fa-copy"></i> Copy Result
                        </button>
                    </div>
                    <div class="result-output" id="result-output"></div>

                    <div class="result-header">
                        <i class="fas fa-list-ol"></i>
                        Step-by-Step Explanation
                    </div>
                    <div class="steps" id="steps"></div>
                </div>

                <!-- Graph Container -->
                <div class="graph-container" id="graph-container">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line" style="color: var(--primary);"></i>
                            Interactive Graph
                        </h3>
                    </div>
                    <div class="graph-canvas-wrapper">
                        <canvas id="graph-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="history-panel">
        <div class="history-header">
            <h3>Computation History</h3>
            <button class="btn-icon" onclick="toggleHistory()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="history-list"></div>
    </div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="shortcuts-hint" id="shortcuts-hint">
        <strong>Keyboard Shortcuts:</strong><br>
        Ctrl+Enter: Compute<br>
        Ctrl+H: History<br>
        Ctrl+/: This menu<br>
        F: Toggle Format<br>
        Esc: Close panels
    </div>

    <script>
        // API Configuration
        const API_ENDPOINTS = [
            'http://localhost:5000/api/compute',
            'https://calcora.onrender.com/api/compute'
        ];
        
        let API_URL = API_ENDPOINTS[0];
        let apiAvailable = false;
        let currentChart = null;
        let computationHistory = [];

        // Initialize
        async function checkApiAvailability() {
            for (const endpoint of API_ENDPOINTS) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation: 'differentiate',
                            expression: 'x',
                            verbosity: 'concise'
                        })
                    });
                    
                    if (response.ok || response.status === 400) {
                        API_URL = endpoint;
                        apiAvailable = true;
                        console.log('âœ“ Using API endpoint:', endpoint);
                        return;
                    }
                } catch (error) {
                    console.log('âœ— Endpoint not available:', endpoint);
                }
            }
            
            showError('API not available. Please ensure the backend server is running.');
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            // Update chart if exists
            if (currentChart) {
                updateChartTheme();
            }
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('theme-icon').className = 'fas fa-sun';
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`${tab}-content`).style.display = 'block';
        }

        // Example setters
        function setExample(expr, variable) {
            document.getElementById('diff-expr').value = expr;
            document.getElementById('diff-var').value = variable;
        }

        function setMatrixExample(operation, matrixA, matrixB = null) {
            document.getElementById('matrix-operation').value = 'matrix_' + operation;
            document.getElementById('matrix-a').value = matrixA;
            if (matrixB) {
                document.getElementById('matrix-b').value = matrixB;
            }
            toggleMatrixB();
        }

        function toggleMatrixB() {
            const operation = document.getElementById('matrix-operation').value;
            const matrixBGroup = document.getElementById('matrix-b-group');
            matrixBGroup.style.display = operation === 'matrix_multiply' ? 'block' : 'none';
        }

        // Matrix preview and validation
        function validateAndPreviewMatrix(textareaId, previewId, dimensionsId) {
            const textarea = document.getElementById(textareaId);
            const preview = document.getElementById(previewId);
            const dimensions = document.getElementById(dimensionsId);
            
            try {
                const value = textarea.value.trim();
                if (!value) {
                    preview.style.display = 'none';
                    return;
                }
                
                const matrix = JSON.parse(value);
                if (Array.isArray(matrix) && matrix.length > 0 && Array.isArray(matrix[0])) {
                    const rows = matrix.length;
                    const cols = matrix[0].length;
                    dimensions.textContent = `${rows}Ã—${cols} matrix`;
                    dimensions.style.color = 'var(--success)';
                    preview.style.display = 'block';
                    preview.style.borderLeft = '3px solid var(--success)';
                } else {
                    throw new Error('Invalid matrix format');
                }
            } catch (e) {
                dimensions.textContent = 'âš  Invalid format - check your brackets and commas';
                dimensions.style.color = 'var(--error)';
                preview.style.display = 'block';
                preview.style.borderLeft = '3px solid var(--error)';
            }
        }

        // Add live validation listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('matrix-a')?.addEventListener('input', () => {
                validateAndPreviewMatrix('matrix-a', 'matrix-a-preview', 'matrix-a-dimensions');
            });
            document.getElementById('matrix-b')?.addEventListener('input', () => {
                validateAndPreviewMatrix('matrix-b', 'matrix-b-preview', 'matrix-b-dimensions');
            });
            // Trigger initial validation
            validateAndPreviewMatrix('matrix-a', 'matrix-a-preview', 'matrix-a-dimensions');
        });

        // Show/hide functions
        let loadingMessages = [
            'Parsing expression...',
            'Applying differentiation rules...',
            'Simplifying result...',
            'Generating step-by-step explanation...'
        ];
        let loadingInterval = null;
        
        function showLoading() {
            document.getElementById('loading').classList.add('visible');
            document.getElementById('result-section').classList.remove('visible');
            document.getElementById('error-banner').classList.remove('visible');
            document.getElementById('graph-container').classList.remove('visible');
            
            // Rotate loading messages
            let messageIndex = 0;
            const loadingText = document.querySelector('.loading-text');
            loadingText.textContent = loadingMessages[0];
            
            loadingInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % loadingMessages.length;
                loadingText.textContent = loadingMessages[messageIndex];
            }, 800);
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('visible');
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }

        function showError(message) {
            hideLoading();
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-banner').classList.add('visible');
        }

        // Result display state - use window scope for global access
        window.currentResultData = null;
        window.isTypesetFormat = true;

        function preprocessLatex(text) {
            // Convert raw math notation to proper LaTeX
            if (!text) return text;
            
            // Replace ** with ^ for powers (must come before * replacement)
            let result = text.replace(/\*\*/g, '^');
            
            // Replace * with \cdot for multiplication
            result = result.replace(/\*/g, '\\cdot ');
            
            return result;
        }

        function formatMatrixForDisplay(matrixStr) {
            // Try to parse and format matrix nicely
            try {
                // Check if it's a matrix-like output
                if (matrixStr.includes('[') && matrixStr.includes(']')) {
                    // Try to parse as JSON first
                    const matrix = JSON.parse(matrixStr);
                    if (Array.isArray(matrix) && Array.isArray(matrix[0])) {
                        // Create HTML table
                        let html = '<table style="margin: 0 auto; border-collapse: collapse; font-family: \'JetBrains Mono\', monospace;">';
                        html += '<tbody>';
                        matrix.forEach((row, i) => {
                            html += '<tr>';
                            // Left bracket
                            if (i === 0) {
                                html += `<td rowspan="${matrix.length}" style="font-size: 3em; padding: 0 0.25rem; vertical-align: middle; line-height: 0.7;">âŽ¡</td>`;
                            }
                            // Matrix values
                            row.forEach((cell, j) => {
                                html += `<td style="padding: 0.5rem 1rem; text-align: center; min-width: 60px; font-size: 1.2em;">${cell}</td>`;
                            });
                            // Right bracket
                            if (i === 0) {
                                html += `<td rowspan="${matrix.length}" style="font-size: 3em; padding: 0 0.25rem; vertical-align: middle; line-height: 0.7;">âŽ¤</td>`;
                            }
                            html += '</tr>';
                        });
                        html += '</tbody></table>';
                        return html;
                    }
                }
            } catch (e) {
                console.log('Matrix formatting failed:', e);
            }
            return matrixStr;
        }

        function showResult(data) {
            hideLoading();
            console.log('Received data:', data);
            
            // Normalize data structure - backend might return different format
            if (!data.output && data.result) {
                data.output = data.result;
            }
            if (!data.graph && data.steps) {
                data.graph = { nodes: data.steps };
            }
            if (!data.graph && !data.steps) {
                data.graph = { nodes: [] };
            }
            
            window.currentResultData = data;
            window.isTypesetFormat = true;
            
            displayResult();
            
            // Display steps
            const stepsContainer = document.getElementById('steps');
            stepsContainer.innerHTML = '';
            
            const steps = (data.graph && data.graph.nodes) || [];
            steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.innerHTML = `
                    <div class="step-rule">[${step.rule}]</div>
                    <div class="step-explanation">${step.explanation}</div>
                `;
                stepsContainer.appendChild(stepDiv);
            });
            
            document.getElementById('result-section').classList.add('visible');
            
            // Scroll to results smoothly
            setTimeout(() => {
                document.getElementById('result-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }, 100);
            
            // Show graph for differentiation
            if (data.operation === 'differentiate' && document.getElementById('show-graph').checked) {
                showGraph(data);
            }
            
            // Add to history
            addToHistory(data);
        }

        function displayResult() {
            if (!window.currentResultData) return;
            
            const output = document.getElementById('result-output');
            const badge = document.getElementById('format-badge');
            
            if (!output || !badge) return;
            
            if (window.isTypesetFormat) {
                // Typeset format (rendered math like in papers)
                output.className = 'result-output typeset';
                badge.innerHTML = '<i class="fas fa-font"></i> Typeset Format';
                
                // Check if it's a matrix
                const isMatrix = window.currentResultData.output && 
                                window.currentResultData.output.includes('[') && 
                                window.currentResultData.output.includes(']');
                
                if (isMatrix) {
                    // Format as matrix
                    const formatted = formatMatrixForDisplay(window.currentResultData.output);
                    output.innerHTML = formatted;
                } else {
                    // Render as LaTeX
                    try {
                        const latexCode = preprocessLatex(window.currentResultData.output);
                        katex.render(latexCode, output, {
                            throwOnError: false,
                            displayMode: true
                        });
                    } catch (e) {
                        output.textContent = window.currentResultData.output;
                    }
                }
            } else {
                // Copyable format (raw LaTeX code)
                output.className = 'result-output copyable';
                badge.innerHTML = '<i class="fas fa-code"></i> LaTeX Code';
                
                // Show LaTeX code
                if (window.currentResultData.latex) {
                    output.textContent = window.currentResultData.latex;
                } else {
                    output.textContent = window.currentResultData.output;
                }
            }
        }

        function toggleResultFormat() {
            if (!window.currentResultData) {
                console.log('No result data to toggle');
                return;
            }
            window.isTypesetFormat = !window.isTypesetFormat;
            console.log('Toggling format to:', window.isTypesetFormat ? 'Typeset' : 'Copyable');
            displayResult();
        }

        function copyResultToClipboard(event) {
            if (!window.currentResultData || !window.currentResultData.output) {
                console.error('No result to copy');
                return;
            }
            
            const textToCopy = window.currentResultData.output;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Show feedback
                const btn = event ? event.target.closest('button') : null;
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    btn.style.background = 'var(--success)';
                    btn.style.color = 'white';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 1500);
                }
                console.log('Copied to clipboard:', textToCopy);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        // Compute functions
        async function computeDifferentiate() {
            const expression = document.getElementById('diff-expr').value.trim();
            const variable = document.getElementById('diff-var').value.trim() || 'x';
            const verbosity = document.getElementById('diff-verbosity').value;

            // Input validation
            if (!expression) {
                showError('âš  Please enter a mathematical expression to differentiate');
                document.getElementById('diff-expr').focus();
                return;
            }
            
            if (!variable) {
                showError('âš  Please specify the variable to differentiate with respect to');
                document.getElementById('diff-var').focus();
                return;
            }
            
            // Check for common syntax errors
            if (expression.includes('^')) {
                showError('âš  Use ** for exponents, not ^. Example: x**2 instead of x^2');
                return;
            }

            showLoading();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'differentiate',
                        expression: expression,
                        variable: variable,
                        verbosity: verbosity
                    })
                });

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('API endpoint not available');
                }

                const data = await response.json();

                if (!response.ok) {
                    showError(data.error || 'Computation failed');
                    return;
                }

                showResult(data);
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function computeMatrix() {
            const operation = document.getElementById('matrix-operation').value;
            const matrixA = document.getElementById('matrix-a').value.trim();
            const verbosity = document.getElementById('matrix-verbosity').value;

            // Validate Matrix A
            if (!matrixA) {
                showError('âš  Please enter Matrix A');
                document.getElementById('matrix-a').focus();
                return;
            }
            
            try {
                JSON.parse(matrixA);
            } catch (e) {
                showError('âš  Matrix A has invalid JSON format. Check your brackets and commas.');
                document.getElementById('matrix-a').focus();
                return;
            }

            showLoading();

            const body = {
                operation: operation,
                expression: matrixA,
                verbosity: verbosity
            };

            if (operation === 'matrix_multiply') {
                const matrixB = document.getElementById('matrix-b').value.trim();
                if (!matrixB) {
                    showError('Matrix multiplication requires Matrix B');
                    hideLoading();
                    return;
                }
                body.matrix_b = matrixB;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('API endpoint not available');
                }

                const data = await response.json();

                if (!response.ok) {
                    showError(data.error || 'Computation failed');
                    return;
                }

                showResult(data);
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // Graph rendering
        function showGraph(data) {
            const container = document.getElementById('graph-container');
            const canvas = document.getElementById('graph-canvas');
            container.classList.add('visible');

            // Generate x values
            const xMin = -10;
            const xMax = 10;
            const points = 200;
            const xValues = [];
            const yOriginal = [];
            const yDerivative = [];

            for (let i = 0; i <= points; i++) {
                const x = xMin + (i / points) * (xMax - xMin);
                xValues.push(x);
                
                // Evaluate original function and derivative
                try {
                    const originalValue = evaluateExpression(data.input, x);
                    const derivativeValue = evaluateExpression(data.output, x);
                    yOriginal.push(originalValue);
                    yDerivative.push(derivativeValue);
                } catch (e) {
                    yOriginal.push(null);
                    yDerivative.push(null);
                }
            }

            // Destroy old chart if exists
            if (currentChart) {
                currentChart.destroy();
            }

            // Create new chart
            const isDark = document.body.classList.contains('dark-theme');
            const ctx = canvas.getContext('2d');
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xValues,
                    datasets: [
                        {
                            label: `f(x) = ${data.input}`,
                            data: yOriginal,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: `f'(x) = ${data.output}`,
                            data: yDerivative,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: isDark ? '#e5e7eb' : '#0f172a',
                                font: {
                                    size: 14,
                                    family: 'JetBrains Mono'
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            grid: {
                                color: isDark ? '#334155' : '#e2e8f0'
                            },
                            ticks: {
                                color: isDark ? '#cbd5e1' : '#64748b'
                            }
                        },
                        y: {
                            grid: {
                                color: isDark ? '#334155' : '#e2e8f0'
                            },
                            ticks: {
                                color: isDark ? '#cbd5e1' : '#64748b'
                            }
                        }
                    }
                }
            });
        }

        // Simple expression evaluator (basic implementation)
        function evaluateExpression(expr, x) {
            // First, convert all ** to a temporary placeholder to avoid issues with parentheses
            let evaluated = expr.replace(/\*\*/g, '^POWER^');
            
            // Replace x with the actual value
            evaluated = evaluated.replace(/x/g, `(${x})`);
            
            // Now convert ^POWER^ to Math.pow with proper syntax
            // This handles cases like sin((value)^POWER^2)
            while (evaluated.includes('^POWER^')) {
                evaluated = evaluated.replace(/(\([^()]*\)|[\d.]+)\^POWER\^(\([^()]*\)|[\d.]+)/g, 'Math.pow($1,$2)');
            }
            
            // Replace trigonometric functions
            evaluated = evaluated.replace(/\bsin\b/g, 'Math.sin');
            evaluated = evaluated.replace(/\bcos\b/g, 'Math.cos');
            evaluated = evaluated.replace(/\btan\b/g, 'Math.tan');
            
            // Replace inverse trig functions
            evaluated = evaluated.replace(/\basin\b/g, 'Math.asin');
            evaluated = evaluated.replace(/\bacos\b/g, 'Math.acos');
            evaluated = evaluated.replace(/\batan\b/g, 'Math.atan');
            
            // Replace hyperbolic functions
            evaluated = evaluated.replace(/\bsinh\b/g, 'Math.sinh');
            evaluated = evaluated.replace(/\bcosh\b/g, 'Math.cosh');
            evaluated = evaluated.replace(/\btanh\b/g, 'Math.tanh');
            evaluated = evaluated.replace(/\basinh\b/g, 'Math.asinh');
            evaluated = evaluated.replace(/\bacosh\b/g, 'Math.acosh');
            evaluated = evaluated.replace(/\batanh\b/g, 'Math.atanh');
            
            // Replace other functions
            evaluated = evaluated.replace(/\bexp\b/g, 'Math.exp');
            evaluated = evaluated.replace(/\blog\b/g, 'Math.log');
            evaluated = evaluated.replace(/\bsqrt\b/g, 'Math.sqrt');
            evaluated = evaluated.replace(/\bAbs\b/g, 'Math.abs');
            evaluated = evaluated.replace(/\babs\b/g, 'Math.abs');
            
            // Error function approximation
            evaluated = evaluated.replace(/\berf\b/g, '__erf');
            
            // Replace constants
            evaluated = evaluated.replace(/\bpi\b/g, 'Math.PI');
            evaluated = evaluated.replace(/\be\b(?!\d)/g, 'Math.E');
            
            try {
                // Define erf function for evaluation
                const __erf = (x) => {
                    // Abramowitz and Stegun approximation
                    const sign = x >= 0 ? 1 : -1;
                    x = Math.abs(x);
                    const a1 = 0.254829592;
                    const a2 = -0.284496736;
                    const a3 = 1.421413741;
                    const a4 = -1.453152027;
                    const a5 = 1.061405429;
                    const p = 0.3275911;
                    const t = 1.0 / (1.0 + p * x);
                    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
                    return sign * y;
                };
                
                return eval(evaluated);
            } catch (e) {
                return null;
            }
        }

        function updateChartTheme() {
            if (!currentChart) return;
            
            const isDark = document.body.classList.contains('dark-theme');
            currentChart.options.plugins.legend.labels.color = isDark ? '#e5e7eb' : '#0f172a';
            currentChart.options.scales.x.grid.color = isDark ? '#334155' : '#e2e8f0';
            currentChart.options.scales.x.ticks.color = isDark ? '#cbd5e1' : '#64748b';
            currentChart.options.scales.y.grid.color = isDark ? '#334155' : '#e2e8f0';
            currentChart.options.scales.y.ticks.color = isDark ? '#cbd5e1' : '#64748b';
            currentChart.update();
        }

        // History functions
        function addToHistory(data) {
            computationHistory.unshift({
                timestamp: new Date(),
                data: data
            });
            
            if (computationHistory.length > 50) {
                computationHistory = computationHistory.slice(0, 50);
            }
            
            updateHistoryPanel();
        }

        function updateHistoryPanel() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            computationHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.data.input}</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">
                        ${item.timestamp.toLocaleString()}
                    </div>
                `;
                div.onclick = () => loadFromHistory(item.data);
                historyList.appendChild(div);
            });
        }

        function loadFromHistory(data) {
            if (data.operation === 'differentiate') {
                document.getElementById('diff-expr').value = data.input;
                switchTab('differentiate');
            }
            toggleHistory();
        }

        function toggleHistory() {
            document.getElementById('history-panel').classList.toggle('visible');
        }

        // Export functions
        function toggleExportMenu() {
            document.getElementById('export-menu').classList.toggle('visible');
        }

        function exportAs(format) {
            // Get current result data
            const output = document.getElementById('result-output').textContent;
            const steps = Array.from(document.querySelectorAll('.step')).map(step => ({
                rule: step.querySelector('.step-rule').textContent,
                explanation: step.querySelector('.step-explanation').textContent
            }));
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            if (format === 'json') {
                content = JSON.stringify({ output, steps }, null, 2);
                filename = 'calcora-result.json';
                mimeType = 'application/json';
            } else if (format === 'text') {
                content = `Result: ${output}\n\nSteps:\n${steps.map((s, i) => `${i + 1}. ${s.rule}\n   ${s.explanation}`).join('\n')}`;
                filename = 'calcora-result.txt';
                mimeType = 'text/plain';
            } else if (format === 'latex') {
                content = `\\documentclass{article}\n\\begin{document}\n\\section*{Result}\n$${output}$\n\\end{document}`;
                filename = 'calcora-result.tex';
                mimeType = 'text/x-latex';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            toggleExportMenu();
        }

        function copyToClipboard() {
            const output = document.getElementById('result-output').textContent;
            navigator.clipboard.writeText(output);
            
            // Show feedback
            const btn = event.target.closest('.export-item');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
                toggleExportMenu();
            }, 1000);
        }

        // Keyboard shortcuts
        function showShortcuts() {
            const hint = document.getElementById('shortcuts-hint');
            hint.classList.add('visible');
            setTimeout(() => {
                hint.classList.remove('visible');
            }, 5000);
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                if (activeTab === 'differentiate') {
                    computeDifferentiate();
                } else {
                    computeMatrix();
                }
            } else if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                toggleHistory();
            } else if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                showShortcuts();
            } else if (e.key === 'Escape') {
                document.getElementById('history-panel').classList.remove('visible');
                document.getElementById('export-menu').classList.remove('visible');
            } else if (e.key === 'f' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                // F key toggles format (only if not in an input)
                if (!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                    e.preventDefault();
                    toggleResultFormat();
                }
            }
        });

        // Initialize
        checkApiAvailability();
        toggleMatrixB();
    </script>
</body>
</html>
